---
title: "Stepwise Forward Selection"
author: "Christian Pascual"
date: "2/10/2019"
output: html_document
---

```{r libraries, message = FALSE}
library(tidyverse)
library(MASS)
library(matrixcalc)
```

# Multiple simulations

```{r simulation-functions }
set.seed(1)
simulate.data = function(n = 300, 
                         c = 1, cor.base = 0.30, strong.coeff = 5,
                         num.strong = 3, num.wai = 10, num.wbc = 10, desired.p = 100) {
  
  num.null = desired.p - (num.strong + num.wai + num.wbc)
  p = desired.p
  weak.threshold = c * sqrt(log(p) / n)
  var.matrix = diag(p)
  
  # ensure 21 - 30 covariates are correlated to the first strong covariate
  var.matrix[1, (num.strong + num.wai + 1):(num.strong + num.wai + num.wbc)] = cor.base
  var.matrix[(num.strong + num.wai + 1):(num.strong + num.wai + num.wbc), 1] = cor.base
  
  if (!is.positive.definite(var.matrix)) {
    return("Given parameters do not form positive definite variance-covariance matrix.")
  }
  
  # simulate the data from multivariate normal
  X = mvrnorm(n = n, mu = rep(0, p), Sigma = var.matrix, empirical = F, tol = 0.1)
  
  b.true = c(
    rep(strong.coeff, num.strong),
    rep(weak.threshold, num.wai), 
    rep(weak.threshold, num.wbc),
    rep(0, num.null) 
  )
  
  Y = 1 + X %*% b.true + rnorm(n)
  data = as.tibble(data.frame(cbind(X, Y)))
  
  # clearly demarcate columns
  cols = c(
    paste("Strong", 1:num.strong, sep = ""),
    paste("WAI", 1:num.wai, sep = ""),
    paste("WBC", 1:num.wbc, sep = ""),
    paste("Null", 1:num.null, sep = ""),
    "Y"
  )
  colnames(data) = cols
  return(data)
}

create.model = function(data) {
  fit = step(object = lm(Y ~ 1, data = data),
             scope = formula(lm(Y ~ ., data = data)), 
             direction = "forward", trace = 0)
  return(fit)
}
```

```{r helper-functions }
# Functions to help with gathering simulation data

# task 1: gather how many predictors were missed by forward selection/LASSO
analyze.missed = function(betas,
                          num.strong = 3, num.wai = 10, num.wbc = 10) {
  strongs = paste("Strong", 1:num.strong, sep = "")
  wais = paste("WAI", 1:num.wai, sep = "")
  wbcs = paste("WBC", 1:num.wbc, sep = "")
  captured = names(betas)

  return(list(
   prct.strong = length(intersect(captured, strongs)) / length(strongs),
   prct.wai = length(intersect(captured, wais)) / length(wais),
   prct.wbc = length(intersect(captured, wbcs)) / length(wbcs)
  ))
}

# task 2 subtask: remove weak predictors from the data before fitting model to it
remove.weaknesses = function(data, rm.wai = 0, rm.wbc = 0) {
  # definte which columns we should remove from WBC and WAI
  cols.to.remove = c(
    paste("WAI", 1:rm.wai, sep = ""),
    paste("WBC", 1:rm.wbc, sep = "")
  )

  return(data[, !(names(data) %in% cols.to.remove)])
}

# task 2 subtask: get the 
analyze.coefficients = function(betas) {
  names(betas) = betas
}
```


```{r}
data1 = simulate.data()
data2 = simulate.data()
# test = remove.weaknesses(data, rm.wai = 1, rm.wbc = 1)
fit1 = create.model(data1)
fit2 = create.model(data2)
prcts1 = analyze.missed(fit1$coefficients)
prcts2 = analyze.missed(fit2$coefficients)
```

```{r}
test = as.tibble(
  bind_rows(fit1$coefficients, fit2$coefficients)
)
test2 = as.tibble(
  bind_rows(prcts1, prcts2)
)
```





